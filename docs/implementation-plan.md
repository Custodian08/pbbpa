# План реализации функциональных требований (UC‑01..UC‑18)

Обновляемый план работ по курсовому проекту. Основан на текущем состоянии кода и перечне UC/ролей из ТЗ.

## Роли и матрица доступа (RBAC)
- ADMIN: пользователи/роли, настройки, аудит, все экспорты/операции.
- MANAGER (менеджер/юрист): договоры, статусы, акты, пролонгации/расторжения.
- OPERATOR (бухгалтер/оператор): биллинг (начисления/счета), платежи, импорт/экспорт.
- ANALYST: витрины, отчёты, KPI/дашборды (read‑only).
- EXEC (руководство): дашборды и KPI (read‑only).
- USER (внешний): каталог доступных помещений и бронирования.

## Сводка покрытия UC
- UC‑01 Справочники: ПОМ/АРЕНД — частично ГОТОВО. Индексации/VAT — TODO.
- UC‑02 Договоры/статусы: частично ГОТОВО (карточка, документы). ЖЦ (пролонгация/расторжение/история) — TODO.
- UC‑03 Начисления/счета: частично ГОТОВО (ручной запуск, PDF/DOCX, Excel). Планировщик/рассылка/пересчёты — TODO.
- UC‑04 Платежи: частично ГОТОВО (ручной/импорт). Авторазнесение/очередь/возвраты — TODO.
- UC‑05 Дебиторка/пени: модель есть; витрины/расчёт/отчёты — TODO.
- UC‑06 Аналитика/отчёты: отчёты частично; KPI/фильтры/дрилл‑даун/экспорт PDF/REST — TODO.
- UC‑07 Дашборд KPI: TODO.
- UC‑08 Доступ/аудит: ГОТОВО (основа), расширить роли/матрицу — TODO.
- UC‑09 Импорт/экспорт/шаблоны: частично; импорт помещений/протокол ошибок — TODO.
- UC‑10/11 Лиды/показы: TODO (отдельный модуль).
- UC‑12 Резервирование: базовая брони — ГОТОВО; подтверждение/уведомления — TODO.
- UC‑13 Подписание: генерация проектов есть; e‑подпись/загрузка подписанных — TODO.
- UC‑14 Акт приёма‑передачи: TODO.
- UC‑15 Пролонгация/изменения: TODO.
- UC‑16 Расторжение: TODO.
- UC‑17 Акт возврата/закрытие: TODO.
- UC‑18 Уведомления/синхронизация: TODO.

## Декомпозиция по задачам (Backlog)
1) RBAC расширение (ADMIN, MANAGER, OPERATOR, ANALYST, EXEC, USER)
- Матрица прав под UC; обновление Guard/декораторов; UI управления ролями.

2) UC‑01 Справочники
- Индексации (UI CRUD, привязка к договору, аудит).
- VAT настройки (UI CRUD, использование в расчётах).
- Валидаторы (уникальность УНП/код, обязательные поля) и сообщения на UI.

3) UC‑02 ЖЦ договора
- Статусы DRAFT/ACTIVE/TERMINATING/CLOSED; операции пролонгация/расторжение.
- История версий (аудит); блокировки конфликтов периодов/площадей.
- Акты: приём/возврат (шаблоны PDF/DOCX, хранение файлов).

4) UC‑03 Биллинг
- Планировщик (cron) периодов; ручной + авто режим.
- Рассылка счетов (e‑mail, шаблоны); пересчёты при индексации/ставках с протоколом.

5) UC‑04 Платежи
- Импорт выписок XLSX/CSV с протоколом ошибок.
- Авторазнесение (по номеру/договору/сумме/дате) + очередь нерешённых (UI для матчинга).
- Частичные оплаты, авансы, возвраты/перерасчёты (модель + UI).

6) UC‑05 Дебиторка/пени
- Витрины aging (0–30/31–60/61–90/90+) и DSO.
- Движок пени (0.1%/день конфиг) + журнал пени + отчёты.

7) UC‑06/07 Аналитика и дашборды
- KPI (заполняемость, доход base/total, дебиторка, DSO, средняя ставка, простой, пени).
- Фильтры и дрилл‑даун до договора/платежа; экспорт PDF/Excel; REST /analytics/*.
- Дашборд EXEC с пресетами и автообновлением.

8) UC‑08 Доступ и аудит (завершение)
- UI ролей, просмотр аудит‑логов с фильтрами, поиск по объектам.

9) UC‑09 Импорт/экспорт (завершение)
- Импорт помещений (endpoint + UI), улучшение шаблонов, расширенный протокол ошибок.

10) UC‑10/11 Лиды/показы
- Карточка лида (контакты/требования/источник), статусы, планирование показа, вложения, итоги показа.

11) UC‑12..17 Договорные операции
- Подписание (e‑подпись интеграция или загрузка подписанного PDF/сканов), подтверждения/уведомления по брони, финальное закрытие договора.

12) UC‑18 Уведомления
- Сервис уведомлений (e‑mail; опционально Telegram/вебхуки), регламенты: брони/счета/просрочка/акты/индексации; синхронизация статусов помещения/договора.

## План по спринтам (предложение на 3–4 недели)
- Спринт 1 (RBAC/база):
  - Установить docx (server) и завершить экспорт DOCX/PNG.
  - AdminUsers: модалка создания пользователя.
  - USER‑каталог: страница доступных помещений + быстрая бронь.
  - VAT/Indexation: базовый UI.
  - Биллинг: cron заготовка.
- Спринт 2 (финансы):
  - Импорт платежей: протокол ошибок, улучшение шаблонов.
  - Авторазнесение и очередь нерешённых.
  - Дебиторка: aging/DSO витрины; пени‑движок.
- Спринт 3 (договора):
  - ЖЦ договора: пролонгации/расторжения/валидации конфликтов.
  - Акты приёма/возврата (PDF/DOCX), архив документов.
  - Уведомления: счета/просрочка/истечение брони.
- Спринт 4 (аналитика):
  - KPI‑дашборд (EXEC/ANALYST), фильтры/дрилл‑даун, экспорт PDF.
  - REST /analytics/* для внешних панелей.

## Технические работы
- Документы: шаблоны PDF/DOCX (консистентные реквизиты организации), e‑подпись (опция).
- Тестирование: e2e для биллинга/платежей/валидаций; фикстуры и seed.
- Логи/аудит: расширенные метаданные, маскирование чувствительных данных.
- Производительность: индексы БД, пагинации, кеш витрин (при необходимости).

## Риски и допущения
- Верификация формул (НДС/индексации/пени) — согласование с бухгалтерией.
- E‑mail/подпись — требуется инфраструктура (SMTP/КЭП или сервис).
- Импорт — различие форматов банковских выгрузок.

## Критерии приёмки (DoD)
- UC‑флоу покрыт UI + API + валидации + аудит + тесты + документация (README/FAQ).
- Экспорты доступны (PDF/DOCX/PNG/Excel), шаблоны валидируются, ошибки протоколируются.
- Роли обеспечивают изоляцию прав; аналитика даёт целевые KPI.

## Ближайшие Next Steps
- AdminUsers.tsx: модалка “Создать пользователя”.
- VAT/Indexation — базовый UI и интеграция в расчёты.

## Прогресс
- [x] Установка docx на сервере и активация DOCX‑экспорта
- [x] Экспорт PNG для таблиц (Invoices/Payments/Premises)
- [x] Экспорт PNG для отдельного счета на странице договора (per‑invoice)
- [x] Публичный каталог доступных помещений + быстрая бронь (страница Catalog)
- [ ] AdminUsers: модалка “Создать пользователя” (в работе)
