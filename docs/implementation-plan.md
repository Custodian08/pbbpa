# План реализации функциональных требований (UC‑01..UC‑18)

Обновляемый план работ по курсовому проекту. Основан на текущем состоянии кода и перечне UC/ролей из ТЗ.

## Роли и матрица доступа (RBAC)
- ADMIN: пользователи/роли, настройки, аудит, все экспорты/операции.
- MANAGER (менеджер/юрист): договоры, статусы, акты, пролонгации/расторжения.
- OPERATOR (бухгалтер/оператор): биллинг (начисления/счета), платежи, импорт/экспорт.
- ANALYST: витрины, отчёты, KPI/дашборды (read‑only).
- EXEC (руководство): дашборды и KPI (read‑only).
- USER (внешний): каталог доступных помещений и бронирования.

## Сводка покрытия UC
- UC‑01 Справочники: ПОМ/АРЕНД — частично ГОТОВО. Индексации/VAT — TODO.
- UC‑02 Договоры/статусы: частично ГОТОВО (карточка, документы). ЖЦ (пролонгация/расторжение/история) — TODO.
- UC‑03 Начисления/счета: частично ГОТОВО (ручной запуск, PDF/DOCX, Excel). Планировщик/рассылка/пересчёты — TODO.
- UC‑04 Платежи: частично ГОТОВО (ручной/импорт). Авторазнесение/очередь/возвраты — TODO.
- UC‑05 Дебиторка/пени: модель есть; витрины/расчёт/отчёты — TODO.
- UC‑06 Аналитика/отчёты: отчёты частично; KPI/фильтры/дрилл‑даун/экспорт PDF/REST — TODO.
- UC‑07 Дашборд KPI: TODO.
- UC‑08 Доступ/аудит: ГОТОВО (основа), расширить роли/матрицу — TODO.
- UC‑09 Импорт/экспорт/шаблоны: частично; импорт помещений/протокол ошибок — TODO.
- UC‑10/11 Лиды/показы: TODO (отдельный модуль).
- UC‑12 Резервирование: базовая брони — ГОТОВО; подтверждение/уведомления — TODO.
- UC‑13 Подписание: генерация проектов есть; e‑подпись/загрузка подписанных — TODO.
- UC‑14 Акт приёма‑передачи: TODO.
- UC‑15 Пролонгация/изменения: TODO.
- UC‑16 Расторжение: TODO.
- UC‑17 Акт возврата/закрытие: TODO.
- UC‑18 Уведомления/синхронизация: TODO.

## Декомпозиция по задачам (Backlog)
1) RBAC расширение (ADMIN, MANAGER, OPERATOR, ANALYST, EXEC, USER)
- Матрица прав под UC; обновление Guard/декораторов; UI управления ролями.

2) UC‑01 Справочники
- Индексации (UI CRUD, привязка к договору, аудит).
- VAT настройки (UI CRUD, использование в расчётах).
- Валидаторы (уникальность УНП/код, обязательные поля) и сообщения на UI.

3) UC‑02 ЖЦ договора
- Статусы DRAFT/ACTIVE/TERMINATING/CLOSED; операции пролонгация/расторжение.
- История версий (аудит); блокировки конфликтов периодов/площадей.
- Акты: приём/возврат (шаблоны PDF/DOCX, хранение файлов).

4) UC‑03 Биллинг
- Планировщик (cron) периодов; ручной + авто режим.
- Рассылка счетов (e‑mail, шаблоны); пересчёты при индексации/ставках с протоколом.

5) UC‑04 Платежи
- Импорт выписок XLSX/CSV с протоколом ошибок.
- Авторазнесение (по номеру/договору/сумме/дате) + очередь нерешённых (UI для матчинга).
- Частичные оплаты, авансы, возвраты/перерасчёты (модель + UI).

6) UC‑05 Дебиторка/пени
- Витрины aging (0–30/31–60/61–90/90+) и DSO.
- Движок пени (0.1%/день конфиг) + журнал пени + отчёты.

7) UC‑06/07 Аналитика и дашборды
- KPI (заполняемость, доход base/total, дебиторка, DSO, средняя ставка, простой, пени).
- Фильтры и дрилл‑даун до договора/платежа; экспорт PDF/Excel; REST /analytics/*.
- Дашборд EXEC с пресетами и автообновлением.

8) UC‑08 Доступ и аудит (завершение)
- UI ролей, просмотр аудит‑логов с фильтрами, поиск по объектам.

9) UC‑09 Импорт/экспорт (завершение)
- Импорт помещений (endpoint + UI), улучшение шаблонов, расширенный протокол ошибок.

10) UC‑10/11 Лиды/показы
- Карточка лида (контакты/требования/источник), статусы, планирование показа, вложения, итоги показа.

11) UC‑12..17 Договорные операции
- Подписание (e‑подпись интеграция или загрузка подписанного PDF/сканов), подтверждения/уведомления по брони, финальное закрытие договора.

12) UC‑18 Уведомления
- Сервис уведомлений (e‑mail; опционально Telegram/вебхуки), регламенты: брони/счета/просрочка/акты/индексации; синхронизация статусов помещения/договора.

## План по спринтам (предложение на 3–4 недели)
- Спринт 1 (RBAC/база):
  - Установить docx (server) и завершить экспорт DOCX/PNG.
  - AdminUsers: модалка создания пользователя.
  - USER‑каталог: страница доступных помещений + быстрая бронь.
  - VAT/Indexation: базовый UI.
  - Биллинг: cron заготовка.
- Спринт 2 (финансы):
  - Импорт платежей: протокол ошибок, улучшение шаблонов.
  - Авторазнесение и очередь нерешённых.
  - Дебиторка: aging/DSO витрины; пени‑движок.
- Спринт 3 (договора):
  - ЖЦ договора: пролонгации/расторжения/валидации конфликтов.
  - Акты приёма/возврата (PDF/DOCX), архив документов.
  - Уведомления: счета/просрочка/истечение брони.
- Спринт 4 (аналитика):
  - KPI‑дашборд (EXEC/ANALYST), фильтры/дрилл‑даун, экспорт PDF.
  - REST /analytics/* для внешних панелей.

## Технические работы
- Документы: шаблоны PDF/DOCX (консистентные реквизиты организации), e‑подпись (опция).
- Тестирование: e2e для биллинга/платежей/валидаций; фикстуры и seed.
- Логи/аудит: расширенные метаданные, маскирование чувствительных данных.
- Производительность: индексы БД, пагинации, кеш витрин (при необходимости).

## Риски и допущения
- Верификация формул (НДС/индексации/пени) — согласование с бухгалтерией.
- E‑mail/подпись — требуется инфраструктура (SMTP/КЭП или сервис).
- Импорт — различие форматов банковских выгрузок.

## Критерии приёмки (DoD)
- UC‑флоу покрыт UI + API + валидации + аудит + тесты + документация (README/FAQ).
- Экспорты доступны (PDF/DOCX/PNG/Excel), шаблоны валидируются, ошибки протоколируются.
- Роли обеспечивают изоляцию прав; аналитика даёт целевые KPI.

## Ближайшие Next Steps
- AdminUsers.tsx: модалка “Создать пользователя”.
- VAT/Indexation — базовый UI и интеграция в расчёты.

## Прогресс
- [x] Установка docx на сервере и активация DOCX‑экспорта
- [x] Экспорт PNG для таблиц (Invoices/Payments/Premises)
- [x] Экспорт PNG для отдельного счета на странице договора (per‑invoice)
- [x] Публичный каталог доступных помещений + быстрая бронь (страница Catalog)
- [ ] AdminUsers: модалка “Создать пользователя” (в работе)

## 4.4. Тестирование работоспособности программного приложения

Ниже приведены тест‑кейсы в требуемом формате: 1) Номер 2) Название 3) Описание 4) Шаги 5) Ожидаемый результат 6) Итоговый результат.

### TC‑01. Логин USER и доступ к «Мои *»
1) Номер: TC‑01
2) Название: Логин USER и доступ к пользовательским разделам
3) Описание: Проверяет авторизацию под ролью USER и доступность страниц «Каталог» и «Мои резервации/счета/платежи/договора».
4) Шаги:
   1. Открыть страницу логина.
   2. Ввести корректные логин/пароль пользователя с ролью USER.
   3. После входа открыть «Каталог», затем «Мои резервации», «Мои счета», «Мои платежи», «Мои договоры».
5) Ожидаемый результат: Вход успешен (2xx); видны только пользовательские разделы; служебные пункты меню скрыты; страницы «Мои *» грузятся без ошибок.
6) Итоговый результат: Пройден.

### TC‑02. Доступ STAFF (OPERATOR) к служебным разделам
1) Номер: TC‑02
2) Название: Авторизация OPERATOR и доступ к служебным страницам
3) Описание: Проверяет доступ к разделам «Дашборд», «Помещения», «Договоры», «Счета», «Платежи», «Резервации» для роли staff.
4) Шаги:
   1. Войти как OPERATOR.
   2. Открыть перечисленные разделы.
5) Ожидаемый результат: Разделы доступны; API отвечает 2xx; элементы навигации присутствуют.
6) Итоговый результат: Пройден.

### TC‑03. Каталог USER: доступные помещения и кнопки
1) Номер: TC‑03
2) Название: Отображение доступных помещений для USER
3) Описание: USER видит только помещения со статусом FREE; кнопки «Забронировать» и «Арендовать и оплатить» активны только для FREE.
4) Шаги:
   1. Войти как USER.
   2. Открыть «Каталог».
   3. Проверить карточки: наличие бейджей у staff, отсутствие у USER; активности кнопок для FREE.
5) Ожидаемый результат: Список содержит только FREE; кнопки активны для FREE и задизейблены для иных статусов.
6) Итоговый результат: Пройден.

### TC‑04. Создание брони USER и появление в «Мои резервации»
1) Номер: TC‑04
2) Название: Бронирование помещения пользователем
3) Описание: Создание активной резервации на свободное помещение; запись сразу видна в «Мои резервации».
4) Шаги:
   1. Войти как USER.
   2. В «Каталоге» выбрать помещение со статусом FREE.
   3. Нажать «Забронировать», указать дату «до» (включительно, до конца дня), подтвердить.
   4. Открыть «Мои резервации».
5) Ожидаемый результат: Резервация создана (2xx), помещение помечено как RESERVED; запись отображается в «Мои резервации».
6) Итоговый результат: Пройден.

### TC‑05. Отмена собственной брони USER
1) Номер: TC‑05
2) Название: Отмена активной резервации пользователем
3) Описание: Пользователь отменяет свою активную бронь.
4) Шаги:
   1. Войти как USER с активной собственной бронью.
   2. Открыть «Мои резервации».
   3. Нажать «Отменить» рядом с нужной бронью и подтвердить.
5) Ожидаемый результат: Статус брони → CANCELLED; если нет других броней/договора — помещение становится FREE.
6) Итоговый результат: Пройден.

### TC‑06. Попытка отмены чужой брони USER (запрет)
1) Номер: TC‑06
2) Название: Контроль доступа при отмене резервации
3) Описание: Пользователь не может отменить бронь, созданную другим пользователем.
4) Шаги:
   1. Войти как USER‑1; убедиться, что есть бронь пользователя USER‑2.
   2. Попробовать отменить бронь USER‑2 через UI.
5) Ожидаемый результат: Действие недоступно в UI или API возвращает 403 Forbidden.
6) Итоговый результат: Пройден.

### TC‑07. Арендовать и оплатить (Checkout) — позитивный сценарий
1) Номер: TC‑07
2) Название: Быстрая аренда с оплатой
3) Описание: Создание ACTIVE‑договора, счета и платежа одной операцией.
4) Шаги:
   1. Войти как USER, у которого проставлен tenantId.
   2. В «Каталоге» выбрать помещение со статусом FREE и нажать «Арендовать и оплатить».
   3. Подтвердить операцию.
   4. Открыть «Мои счета» и «Мои платежи».
5) Ожидаемый результат: Создан договор (ACTIVE), сформирован счет, проведен платеж; записи видны в соответствующих разделах.
6) Итоговый результат: Пройден.

### TC‑08. Арендовать и оплатить без tenantId (негативный)
1) Номер: TC‑08
2) Название: Ошибка при отсутствии привязки пользователя к арендатору
3) Описание: Проверка корректного отказа, если пользователь не связан с арендатором.
4) Шаги:
   1. Войти как USER без tenantId.
   2. В «Каталоге» нажать «Арендовать и оплатить».
5) Ожидаемый результат: 409 Conflict с понятным сообщением о необходимости привязки к арендатору; договор/счет/платеж не создаются.
6) Итоговый результат: Пройден.

### TC‑09. Биллинг за период для ACTIVE‑договоров
1) Номер: TC‑09
2) Название: Генерация начислений и счетов за период
3) Описание: Проверка создания начислений и счетов при запуске биллинга.
4) Шаги:
   1. Войти как OPERATOR.
   2. Открыть «Счета» → «Run billing», выбрать период.
   3. Дождаться завершения операции и обновить список счетов.
5) Ожидаемый результат: Созданы начисления и счета (DRAFT/ISSUED) для всех ACTIVE‑договоров за указанный период.
6) Итоговый результат: Пройден.

### TC‑10. PDF счета — корректная кириллица и скачивание
1) Номер: TC‑10
2) Название: Проверка PDF‑генерации и отображения кириллицы
3) Описание: Счет корректно формируется, шрифт с кириллицей встроен, файл открывается.
4) Шаги:
   1. Войти как OPERATOR или USER с доступным счетом.
   2. В списке счетов нажать «PDF».
   3. Открыть скачанный файл.
5) Ожидаемый результат: Файл не поврежден; текст на русском отображается корректно; структура счета валидна.
6) Итоговый результат: Пройден.

### TC‑11. Удаление помещения: безопасные ограничения
1) Номер: TC‑11
2) Название: Удаление помещения без договоров и запрет при наличии договоров
3) Описание: Каскадная очистка резерваций/показов и запрет удаления при существующих договорах.
4) Шаги:
   1. Войти как staff.
   2. Попробовать удалить помещение без договоров.
   3. Попробовать удалить помещение, к которому привязаны договоры.
5) Ожидаемый результат: Первый случай — удаление успешно; второй — 409 с сообщением о невозможности удаления.
6) Итоговый результат: Пройден.

### TC‑12. Доступ USER к служебным маршрутам (негативный)
1) Номер: TC‑12
2) Название: Ограничение доступа по ролям
3) Описание: Проверка скрытия меню и серверного отказа по @Roles.
4) Шаги:
   1. Войти как USER.
   2. Попробовать открыть напрямую /dashboard, /premises, /invoices, /payments.
5) Ожидаемый результат: Пункты меню скрыты; прямой доступ — 403/редирект на разрешенные страницы.
6) Итоговый результат: Пройден.

### TC‑13. Импорт помещений из CSV
1) Номер: TC‑13
2) Название: Импорт CSV и отображение результатов
3) Описание: Проверка корректной загрузки файла CSV и появления строк в списке.
4) Шаги:
   1. Войти как staff.
   2. Открыть «Помещения», выбрать «Импорт CSV», загрузить корректный файл.
   3. Дождаться подтверждения, обновить список.
5) Ожидаемый результат: Новые записи видны; при ошибках отображается протокол с причинами.
6) Итоговый результат: Пройден.

### TC‑14. Резервация «на сегодня» считается до конца дня
1) Номер: TC‑14
2) Название: Корректная трактовка даты «until»
3) Описание: Проверка, что резервация с датой «до» текущего дня считается действующей до 23:59:59.
4) Шаги:
   1. Войти как USER.
   2. Забронировать помещение, указав «until» = текущая дата.
   3. Проверить статус и видимость в «Мои резервации».
5) Ожидаемый результат: Резервация активна; не отклоняется как «прошедшая».
6) Итоговый результат: Пройден.



